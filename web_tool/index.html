<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>Land Cover Mapping</title>

    <!-- Core CSS -->
    <link href="css/leaflet.css" rel="stylesheet" />
    <link href="css/leaflet-slider.css" rel="stylesheet" />
    <link href="css/leaflet-sidebar.css" rel="stylesheet" />
    <link href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <link href="css/noty.css" rel="stylesheet">

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    
    <style type="text/css">
        html, body {
            height: 100%;
            height: 100%;
        }

        body {
            padding: 0;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 100%;
        }

        .leaflet-control-slider{
            border-radius: 2px; 
        }
        
        .sidebar{
            border: 0 !important;
            right: 20px !important;
        }
        .sidebar-content{
            right: 0 !important;
        }
        .sidebar-header{
            background-color: #19715E;
            font-family: "Segoe UI Web (West European)",Segoe UI,-apple-system,BlinkMacSystemFont,Roboto,Helvetica Neue,sans-serif;
            font-size: 1.2em;
            letter-spacing: .1rem;
            font-weight: 400;
            color: white;
        }
        .sidebar-tabs{
            background-color: rgba(255, 255, 255, 0.95);
        }

        #inputNAIP{
            width: 125px;
            height: 125px;
            margin: 10px;
        }

        .exampleImage{
            width: 125px;
            height: 125px;
            margin: 10px;
        }

        .exampleImage.active{
            border: 2px solid red;
        }

        .leaflet-image-layer.gray{
            filter: grayscale(66%);
        }

        .slider{
            height: 25px;
            width: 100%;
        }

       button {
            color: #ccc;
            background-color: #595959;
            border: solid 3px #6e6e6e;
            width: 85%;
            height: 40px;
        }

        button:hover{
            cursor: pointer;
            cursor: hand;
            text-decoration: none;
            color: #fff;
        }

        a.leaflet-control-slider-toggle {
            width: 171px;
        }

        .logo-area{
            background-color: #19715E;
            width:300px;
            height:70px;
            display: flex !important;
            flex-basis: auto;
            flex-grow: 1;
            align-items: center;
            font-family: "Segoe UI Web (West European)",Segoe UI,-apple-system,BlinkMacSystemFont,Roboto,Helvetica Neue,sans-serif;
        }

        .logo-text{
            font-size: 1.7em;
            letter-spacing: .1rem;
            font-weight: 400;
            line-height: 1.5;
            color: white;
            padding: 2px;
            padding-right: 2rem;
            padding-left: 2rem;
        }

        .logo-link{
            font-size: 100%;
            font-weight: 400;
            color: white;
            padding-right: 1.5rem;
            padding-left: 1.5rem;
        }
        
        .m-0{
            margin: 0 !important;
        }
        
        .leaflet-container .logo-area a {
            color: #19715E;
        }
        
        .leaflet-container .logo-area a:hover {
            color: #25A782;
        }

        .radio-selected{
            border: 1px solid black;
        }
        .radio{
            padding:10px;
            width:300px;
        }

        .noty_theme__metroui.noty_type__success{
            background-color: #19715E !important;
        }

        .label-area{
            background-color: #FFFFFF;
            width:200px;
            padding:20px;
        }

        .label-text{
            font-size: 1em;
            letter-spacing: .1rem;
            font-weight: 400;
            line-height: 1.5;
            color: black;
            padding: 2px;
            padding-left: 1rem;
        }

        .endOfTrial{
            font-size: 1.7em;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50% , -50%);
            -webkit-transform: translate(-50%, -50%);
            background-color: white;
            padding: 50px;
            z-index: 9999;
            border-radius: 3px;
            max-width: 400px;
        }

        .endOfTrialMask{
            position:absolute;
            top: 0;
            left: 0;
            width:100%;
            height:100%;
            background-color: #77777777;
            z-index: 9998;
        }


    </style>

</head>

<body>

    <div id="map"></div>
    
    <div id="sidebar" class="sidebar">
    
        <!-- Tab panes -->
        <div class="sidebar-content">

            <!-- Start of "home" tab -->
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    <!--
                    <span class="sidebar-close">
                        <i class="fa fa-caret-right"></i>
                    </span>
                    -->
                </h1>
    
    
                <div style="text-align: center; margin-bottom:10px;" id="inputImages">
                    <h3>NAIP Input</h3>
                    <img id="inputNAIP">
                </div>

                <div style="text-align: center; margin-bottom:10px; width:100%;" id="exampleImages">
                    <h3>Land Cover Predictions</h3>
                    <div id="exampleImageList">
                    </div>
                </div>

                <div style="margin-bottom:10px;" id="classChanges">

                    <h3 style="text-align: center; margin-top:20px;">Correction type:</h3>
                    <div style="padding-left:20px">
                        <div class="radio radio-selected">
                            <label><input type="radio" name="new-class" value="water" checked>Water (<span id="label-water">0</span> samples since last retrain)</label>
                        </div>
                        <div class="radio">
                            <label><input type="radio" name="new-class" value="forest">Tree Canopy (<span id="label-forest">0</span> samples since last retrain)</label>
                        </div>
                        <div class="radio">
                            <label><input type="radio" name="new-class" value="field">Field (<span id="label-field">0</span> samples since last retrain)</label>
                        </div>
                        <div class="radio">
                            <label><input type="radio" name="new-class" value="built">Built (<span id="label-built">0</span> samples since last retrain)</label>
                        </div>

                        <div style="text-align: center; margin-top:10px;">
                            <button id="btnRetrain">Retrain (<span id="label-retrains">0</span> times)</button>
                        </div>
                        <div style="text-align: center; margin-top:10px;">
                            <button id="btnReset">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End of "home" tab -->
        </div>
    </div>

    <!-- Core JavaScript
    ================================================== -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/noty.js" type="text/javascript"></script>

    <!-- Leaflet JavaScript
    ================================================== -->
    <script src="js/leaflet.js" type="text/javascript"></script>
    <script src="js/leaflet-slider.js" type="text/javascript"></script>
    <script src="js/leaflet-sidebar.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js" type="text/javascript"></script>

    <!-- List of backend URLS to query
    ================================================== -->
    <script src="endpoints.js" type="text/javascript"></script>
    <script src="endpoints.mine.js" type="text/javascript"></script>

    <script type="text/javascript">

        var processingServiceURL = ENDPOINTS[0]["url"];
        var EXP_NAME = "TEST";

        var START_CENTER = [38, -94]; // lat, lon
        var START_ZOOM = 4;

        var SELECTION_SIZE = 200; // in meters, probably
        var CORRECTION_SIZE = 1;

        var selectionBox = null;
        var currentSelection = null;

        var newClass = "water";
        var classColors = {
            "water":"#0000FF",
            "forest":"#008000",
            "field":"#80FF80",
            "built":"#806060"
        }
        var rightMouseDown = false;
        var shiftKeyDown = false;

        var currentPatches = [];

        var trainingSetBoundaries = [
            new L.geoJson(),
            new L.geoJson(),
            new L.geoJson(),
            new L.geoJson(),
            new L.geoJson()
        ]

        var visible = true;
        var opacitySlider;
        
        var trainingSetLocations = [
            [39.40625604822793804, -76.5937627969694006 ], // This is the demo set
            [42.406253302897575  , -77.12504090737812135],
            [42.40625552034823897, -76.87503698687157794],
            [42.46875623949721046, -76.50003291357666058],
            [43.09375587600650448, -76.18754117285706684]
        ]

        var soft0_hard1 = 1;
        var pred0_naip1 = 0;
        var activeImgIdx = 0;


        var labelCounts = {
            "water": 0,
            "forest": 0,
            "field": 0,
            "built": 0
        }
        var retrainCounts = 0

        var map = null;
        var animating = false;

        var doRetrain = function(){
            $.ajax({
                type: "POST",
                url: processingServiceURL + "retrainModel",
                data: JSON.stringify({"retrain": true, "experiment": EXP_NAME}),
                success: function(data, textStatus, jqXHR){
                    if(data["success"]){
                        notifySuccess(data, textStatus, jqXHR);
                        retrainCounts += 1;

                        $("#label-retrains").html(retrainCounts);
                        for( k in labelCounts){
                            labelCounts[k] = 0;
                            $("#label-"+k).html("0");
                        }

                        var t = currentSelection._latlngs[0];
                        var curSelPoly = [
                            [t[0]["lat"], t[0]["lng"]],
                            [t[1]["lat"], t[1]["lng"]],
                            [t[2]["lat"], t[2]["lng"]],
                            [t[3]["lat"], t[3]["lng"]]
                        ];
                        requestPatches(curSelPoly);
                    }
                },
                error: notifyFail,
                dataType: "json",
                contentType: "application/json"
            });
        };

        var doReset = function(notify=true){
            var request = {
                "reset": true,
                "experiment": EXP_NAME
            };
            $.ajax({
                type: "POST",
                url: processingServiceURL + "resetModel",
                data: JSON.stringify(request),
                success: function(data, textStatus, jqXHR){
                    if(data["success"] && notify){
                        notifySuccess(data, textStatus, jqXHR);
                        
                        $("#label-retrains").html("0");

                        for( k in labelCounts){
                            labelCounts[k] = 0;
                            $("#label-"+k).html("0");
                        }
                    }
                },
                error: notifyFail,
                dataType: "json",
                contentType: "application/json"
            });
        };

        var animateSuccessfulCorrection = function(countdown, time){
            animating = true;
            selectionBox.setStyle({weight:countdown})
            if(countdown > 2){
                window.setTimeout(function(){animateSuccessfulCorrection(countdown-1);}, time);
            }else{
                animating = false;
            }
        }


        var sendCorrection = function(polygon, idx){
            var topleft = L.latLng(polygon[0][0], polygon[0][1]);
            var topleftProjected = L.CRS.EPSG3857.project(topleft);
            var bottomright = L.latLng(polygon[2][0], polygon[2][1]);
            var bottomrightProjected = L.CRS.EPSG3857.project(bottomright);
            
            var request = {
                "extent": {
                    "xmax": bottomrightProjected.x,
                    "xmin": topleftProjected.x,
                    "ymax": topleftProjected.y,
                    "ymin": bottomrightProjected.y,
                    "spatialReference": {
                        "latestWkid": 3857
                    }
                },
                "value" : newClass,
                "experiment": EXP_NAME
            };


            $.ajax({
                type: "POST",
                url: processingServiceURL + "recordCorrection",
                data: JSON.stringify(request),
                success: function(data, textStatus, jqXHR){
                    console.debug("Successfully recorded correction");
                    console.debug(data);

                    //labelCounts[data["value"]] += data["count"];
                    labelCounts[data["value"]] += 1;

                    $("#label-"+data["value"]).html(labelCounts[data["value"]]);
                    animateSuccessfulCorrection(10, 80);
                    //notifySuccess(data, textStatus, jqXHR);
                    
                    /* var srcs = [
                        "data:image/png;base64," + data.output_soft,
                        "data:image/png;base64," + data.output_hard,
                    ];

                    var tActiveImgIdx = currentPatches[idx]["activeImgIdx"];
                    currentPatches[idx]["patches"][tActiveImgIdx]["srcs"] = srcs;
                    $("#exampleImage_"+tActiveImgIdx).attr("src", srcs[soft0_hard1]);
                    
                    if(pred0_naip1 == 0){
                        currentPatches[idx]["imageLayer"].setUrl(srcs[soft0_hard1]);
                    } */
                },
                error: notifyFail,
                dataType: "json",
                contentType: "application/json"
            });
        };

        var requestPatches = function(polygon){

            // Setup placeholders for the predictions from the current click to be saved to
            currentPatches.push({
                "naipImg": null,
                "imageLayer": L.imageOverlay("", L.polygon(polygon).getBounds(), {pane: "labels"}).addTo(map),
                "patches": [],
                "activeImgIdx": activeImgIdx
            });
            var idx = currentPatches.length-1;
            
            // Request input image from the first server we know about
            requestInputPatch(idx, polygon, ENDPOINTS[0]["url"]);
            for(var i=0; i<ENDPOINTS.length; i++){
                //console.debug("Running requestPatch on " + ENDPOINTS[i]["url"]);
                currentPatches[idx]["patches"].push({
                    "srcs": null
                });
                requestPatch(idx, polygon, i, ENDPOINTS[i]["url"]);
            }
        };

        var requestInputPatch = function(idx, polygon, serviceURL){
            var topleft = L.latLng(polygon[0][0], polygon[0][1]);
            var topleftProjected = L.CRS.EPSG3857.project(topleft);
            var bottomright = L.latLng(polygon[2][0], polygon[2][1]);
            var bottomrightProjected = L.CRS.EPSG3857.project(bottomright);

            var request = {
                "extent": {
                    "xmax": bottomrightProjected.x,
                    "xmin": topleftProjected.x,
                    "ymax": topleftProjected.y,
                    "ymin": bottomrightProjected.y,
                    "spatialReference": {
                        "latestWkid": 3857
                    }
                },
            };

            $.ajax({
                type: "POST",
                url: serviceURL + "getInput",
                data: JSON.stringify(request),
                success: function(data, textStatus, jqXHR){
                    var resp = data;
                    var naipImg = "data:image/png;base64," + resp.input_naip;
                    currentPatches[idx]["naipImg"] = naipImg 
                    $("#inputNAIP").attr("src", naipImg);

                    if(pred0_naip1 == 1){
                        //var imageLayer = L.imageOverlay(naipImg, L.polygon(polygon).getBounds()).addTo(map);
                        currentPatches[idx]["imageLayer"].setUrl(naipImg);
                    }
                },
                error: notifyFail,
                dataType: "json",
                contentType: "application/json"
            });
        };
        
        
        var requestPatch = function(idx, polygon, currentImgIdx, serviceURL){
            var topleft = L.latLng(polygon[0][0], polygon[0][1]);
            var topleftProjected = L.CRS.EPSG3857.project(topleft);
            var bottomright = L.latLng(polygon[2][0], polygon[2][1]);
            var bottomrightProjected = L.CRS.EPSG3857.project(bottomright);

            var request = {
                "extent": {
                    "xmax": bottomrightProjected.x,
                    "xmin": topleftProjected.x,
                    "ymax": topleftProjected.y,
                    "ymin": bottomrightProjected.y,
                    "spatialReference": {
                        "latestWkid": 3857
                    }
                }
            };
            
            $.ajax({
                type: "POST",
                url: serviceURL + "predPatch",
                data: JSON.stringify(request),
                success: function(data, textStatus, jqXHR){
                    var resp = data;

                    var srcs = [
                        "data:image/png;base64," + resp.output_soft,
                        "data:image/png;base64," + resp.output_hard,
                    ];
                    
                    var img = $("#exampleImage_"+currentImgIdx);
                    img.attr("src", srcs[soft0_hard1]);
                    img.attr("data-name", resp.model_name);                    

                    if(currentImgIdx == currentPatches[idx]["activeImgIdx"]){
                        img.addClass("active");

                        if(pred0_naip1 == 0){
                            //var imageLayer = L.imageOverlay(srcs[soft0_hard1], L.polygon(polygon).getBounds()).addTo(map);
                            currentPatches[idx]["imageLayer"].setUrl(srcs[soft0_hard1]);
                        }
                    }
                    currentPatches[idx]["patches"][currentImgIdx]["srcs"] = srcs;
                },
                error: notifyFail,
                dataType: "json",
                contentType: "application/json"
            });
        };

        var notifySuccess = function(data, textStatus, jqXHR){
            var resp = data;
            var respType = 'success';

            if(!resp.success){
                respType = 'error'
            }
            new Noty({
                type: respType,
                text: resp.message,
                layout: 'topCenter',
                timeout: 500,
                theme: 'metroui'
            }).show();        
        };

        var notifyFail = function(jqXHR, textStatus, errorThrown){
            var response = $.parseJSON(jqXHR.responseText);
            console.log("Error in processing server: " + response.error);
            new Noty({
                type: "error",
                text: "Error in processing server: " + response.error,
                layout: 'topCenter',
                timeout: 2000,
                theme: 'metroui'
            }).show();
        };
        
        var isPointInsidePolygon = function(latlng, poly) {
            // Taken from https://stackoverflow.com/questions/31790344/determine-if-a-point-reside-inside-a-leaflet-polygon
            var polyPoints = poly.getLatLngs()[0];
            var x = latlng.lat, y = latlng.lng;
            
            var inside = false;
            for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
                var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
                var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

                var intersect = ((yi > y) != (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        };

        var getPolyAround = function(latlon, radius){
            // We convert the input lat/lon into the EPSG3857 projection,
            // define our square, then re-convert to lat/lon 
            var latlonProjected = L.CRS.EPSG3857.project(latlon);
            var x = latlonProjected.x;
            var y = latlonProjected.y;
            
            var top = y + radius/2;
            var bottom = y - radius/2;
            var left = x - radius/2;
            var right = x + radius/2;

            top = Math.round(top);
            bottom = Math.round(bottom);
            left = Math.round(left);
            right = Math.round(right);
            
            // left/right are "x" points while top/bottom are the "y" points
            var topleft = L.CRS.EPSG3857.unproject(L.point(left, top));
            var bottomright = L.CRS.EPSG3857.unproject(L.point(right, bottom));
            
            return [[topleft.lat, topleft.lng],
                    [topleft.lat, bottomright.lng],
                    [bottomright.lat, bottomright.lng],
                    [bottomright.lat, topleft.lng]];
        };

        var setupTrainingSets = function(i){

            var url = null;
            if(i==0){
                url = "data/demo_set_1_boundary.geojson"
            }else{
                url = "data/training_set_"+(i)+"_boundary.geojson"
            }

            trainingSetBoundaries[i].addTo(map);
            $.ajax({
                dataType: "json",
                url: url,
                success: function(data) {
                    $(data.features).each(function(key, data) {
                        trainingSetBoundaries[i].addData(data);
                    });
                    trainingSetBoundaries[i].setStyle({
                        "color": "#ff7800",
                        "weight": 4,
                        "fill": false
                    })
                }
            });
        };

        var pad = function(n, width, z) {
            z = z || '0';
            n = n + '';
            return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
        }

        var runTimer = function(timeRemaining){
            if(timeRemaining > 0){
                var minutes = Math.floor(timeRemaining / 60)
                var seconds = timeRemaining % 60;
                $("#timer").html(pad(minutes,2)+":"+pad(seconds,2));
                window.setTimeout(function(){runTimer(timeRemaining-1)}, 1000);
            } else{
                $("#timer").html("00:00");
                $("body").append("<div class='endOfTrial'> Thanks for labeling! Please move on to the next trial. </div>");
                $("body").append("<div class='endOfTrialMask'></div>");
            }
        }
       
        $(document).ready(function(){

            document.onselectstart = function() {
                return false;
            }

            //----------------------------------------------------------------------
            // Parse URL arguments
            //----------------------------------------------------------------------
            var url = new URL(window.location.href);
            var trainingSetID = url.searchParams.get("trainingSetID");
            var userID = url.searchParams.get("userID");
            var modelID = url.searchParams.get("modelID");
            var maxTime = url.searchParams.get("maxTime");
            if(trainingSetID === null){
                trainingSetID = 0;
            } else{
                trainingSetID = parseInt(trainingSetID);
            }
            if(userID === null) userID = "test";
            if(modelID === null) modelID = "test";
            if(maxTime === null){
                maxTime = 15*60;
            } else{
                maxTime = parseInt(maxTime);
            }
            runTimer(maxTime);
            EXP_NAME = userID + "_" + modelID + "_" + trainingSetID;


            //----------------------------------------------------------------------
            // Setup map layers
            //----------------------------------------------------------------------
            var NAIP_Imagery = null;
            if(trainingSetID == 0){
                NAIP_Imagery = L.tileLayer('tiles/demo_set_1/{z}/{x}/{y}.png', {
                    attribution: 'Georeferenced Image', 
                    tms:true,
                    maxZoom:18,
                    minZoom:13
                });
            }else{
                NAIP_Imagery = L.tileLayer('tiles/training_set_'+trainingSetID+'/{z}/{x}/{y}.png', {
                    attribution: 'Georeferenced Image', 
                    tms:true,
                    maxZoom:18,
                    minZoom:13
                });
            }

            map = L.map('map', {
                zoomControl: false,
                crs: L.CRS.EPSG3857, // this is a default, but I'm setting it to be explicit about what CRS we are in	
                center: trainingSetLocations[trainingSetID],
                zoom: 13,
                layers: [NAIP_Imagery]
            });
            map.createPane('labels');
            map.getPane('labels').style.zIndex = 200;

            //---------------------------------------------------------------------
            // Setup AI4E Branding
            //----------------------------------------------------------------------
            var logoControl = $("<div class='leaflet-control logo-area'></div>");
            logoControl.append("<span class='logo-text'> Land Cover Mapping </span>");
            
            $(".leaflet-top.leaflet-left").append(logoControl)

            // Add div for displaying lat/lon
            var timerControl = $("<div class='leaflet-control label-area'></div>");
            timerControl.append("<div class='label-text'>Time remaining <span id='timer'>00:00</span></div>");
            $(".leaflet-top.leaflet-left").append(timerControl);

            
            //----------------------------------------------------------------------
            // Custom initialization of the map zoom controls so that we can 
            // position it where we want
            //----------------------------------------------------------------------
            L.control.zoom({
                position:'topleft'
            }).addTo(map);

            //----------------------------------------------------------------------
            // Setup the geojson boundaries around our training sets
            //----------------------------------------------------------------------
            setupTrainingSets(trainingSetID);

            //----------------------------------------------------------------------
            // Setup leaflet-slider plugin, we make two sliders to control opacity
            // and selection window size
            //----------------------------------------------------------------------
            opacitySlider = L.control.slider( // opacity slider
                function(value){
                    map.getPane('labels').style.opacity = value / 100.0;
                }, {
                    position: 'bottomleft',
                    id: 'opacity_slider',
                    orientation: 'horizontal',
                    collapsed: true,
                    syncSlider: true,
                    min: 0,
                    max: 100,
                    value: 100,
                    logo: "Opacity",
                    size: "171px"
                }
            );
            opacitySlider.addTo(map);
            

            //----------------------------------------------------------------------
            // Setup leaflet-sidebar-v2 and open the "#home" tab 
            //----------------------------------------------------------------------
            var sidebar = L.control.sidebar(
                'sidebar', {
                    position: 'right'
                }
            ).addTo(map);
            sidebar.open("home")        

            //----------------------------------------------------------------------
            // Setup map selection handlers
            //----------------------------------------------------------------------
            map.addEventListener('mousemove', function(e){


                // Choose style
                var curSelPoly = null;
                if(!shiftKeyDown){
                    curSelPoly = getPolyAround(e.latlng, CORRECTION_SIZE);
                }else{
                    curSelPoly = getPolyAround(e.latlng, SELECTION_SIZE);
                }

                if(selectionBox === null){
                    selectionBox = L.polygon(curSelPoly, {
                        color: "#000000",
                        fillColor: "#ffffff",
                        weight: 2
                    });
                    selectionBox.addTo(map);
                }else{
                    if(!animating){
                        selectionBox.setStyle({
                            color: "#000000",
                            fillColor: "#ffffff",
                            weight: 2
                        });
                    }
                    selectionBox.setLatLngs(curSelPoly);
                }
            });

            map.addEventListener('click', function(e){
                
                var curSelPoly = null;
                if(shiftKeyDown){
                    // Run the inference path
                    curSelPoly = getPolyAround(e.latlng, SELECTION_SIZE);
                    console.debug(curSelPoly);
                    if(currentSelection === null){ // This condition creates the red selection box on the first click
                        currentSelection = L.polygon(curSelPoly, {
                            color: "#ff0000",
                            fillColor: "#ffffff",
                            weight: 2
                        });
                        currentSelection.addTo(map);
                    }else{
                        currentSelection.setLatLngs(curSelPoly);
                    }
   
                    requestPatches(curSelPoly);
                }else{
                    // Run the add sample path
                    if(currentSelection !== null){
                        if(isPointInsidePolygon(e.latlng, currentSelection)){
                            curSelPoly = getPolyAround(e.latlng, CORRECTION_SIZE);
                            var idx = currentPatches.length-1;
                            sendCorrection(curSelPoly, idx);
                        }else{
                            console.debug("Click not in selection");
                        }
                    }
                }
            });

            map.on('contextmenu',function(e){}); // disables the context menu
            map.on('dblclick',function(e){});
            map.doubleClickZoom.disable();
            map.boxZoom.disable();

            $(document).keydown(function(e){
                shiftKeyDown = e.shiftKey;
            });
            $(document).keyup(function(e){
                shiftKeyDown = e.shiftKey;
            });

            $(document).keypress(function(e) {
                console.debug(e.which);
                if(e.which == 97 || e.which == 65) { // "a"
                    visible = false;
                    map.getPane('labels').style.opacity = 0.0;
                    opacitySlider.slider.value = 0;
                    opacitySlider._updateValue();
                } else if(e.which == 115 || e.which == 83) { // "s"
                    if(visible){
                        visible = false;
                        map.getPane('labels').style.opacity = 0.0;
                        opacitySlider.slider.value = 0;
                        opacitySlider._updateValue();
                    }else{
                        visible = true;
                        map.getPane('labels').style.opacity = 1.0;
                        opacitySlider.slider.value = 100;
                        opacitySlider._updateValue();
                    }
                } else if(e.which == 100 || e.which == 68) { "d"
                    visible = true;
                    map.getPane('labels').style.opacity = 1.0;
                    opacitySlider.slider.value = 100
                    opacitySlider._updateValue();
                } else if(e.which == 114 || e.which == 82){ "r"
                    doRetrain();
                }
            });


            //TODO these can all be combined into one function
            $("#btnRetrain").click(doRetrain);
            $("#btnReset").click(doReset);


            //----------------------------------------------------------------------
            // Setup radio button change detection
            //----------------------------------------------------------------------
            $('input[type=radio][name=new-class]').change(function() {
                $('input[type=radio][name=new-class]').parent().parent().removeClass("radio-selected");
                $(this).parent().parent().addClass("radio-selected");
                newClass = this.value;
                console.debug(this.value);
            });
            
            //----------------------------------------------------------------------
            // Setup the example images list
            //----------------------------------------------------------------------
            for(var i=0; i<ENDPOINTS.length; i++){
                var img = $("<img class='exampleImage'>");
                img.attr("im-id", i);
                img.attr("id", "exampleImage_"+i);
                $("#exampleImageList").append(img);
            }

            $(".exampleImage").click(function(){
                $(".exampleImage").removeClass("active");
                $(this).addClass("active");
                
                var idx = currentPatches.length-1;
                activeImgIdx = $(this).attr("im-id");

                var srcs = currentPatches[idx]["patches"][activeImgIdx]["srcs"];
                currentPatches[idx]["imageLayer"].setUrl(srcs[soft0_hard1]);
                currentPatches[idx]["activeImgIdx"] = activeImgIdx;
                $(this).attr("src", srcs[soft0_hard1]);
            });


            doReset(false);

        });

    </script>
</body>

</html>
